<apex:page id="pg" standardController="Account" extensions="RKCB_AccountCBController" tabStyle="Account">
	
	<apex:stylesheet value="{!URLFOR($Resource.JQueryUI ,'css/cupertino/jquery-ui-1.8.12.custom.css')}" />
	<apex:includeScript value="{!URLFOR($Resource.JQueryUI ,'js/jquery-1.5.1.min.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.JQueryUI ,'js/jquery-ui-1.8.12.custom.min.js')}" />
	
	<script type="text/javascript">
		j$=jQuery.noConflict();
		
		j$(document).ready(function(){
			initParams();
		});
		
		//Fetches and parses the JSON response received from Crunchbase 
		function getCrunchbaseJSONResponse(pPermalink){
		
			var crunchbaseUrl = pPermalink;
			crunchbaseUrl = crunchbaseUrl.trim() + "?callback=?";
			//alert("Fetching data from Crunchbase....");
			
			j$.getJSON(
				 crunchbaseUrl,
				 function(cbResponse){
				 
				   j$("#response").append("<p><b>Name: </b>" + cbResponse.name + "</p>" +
				   						 "<p><b>Permalink: </b>" + cbResponse.permalink + "</p>" + 
				   						 "<p><b>Crunchbase URL: </b>" + cbResponse.crunchbase_url + "</p>" +
				   						 "<p><b>Blog URL: </b>" + cbResponse.blog_url + "</p>" +
				   						 "<p><b>Homepage URL: </b>" + cbResponse.homepage_url + "</p>" +
				   						 "<p><b>Founded Year: </b>" + cbResponse.founded_year + "</p>" +
				   						 "<p><b>Phone: </b>" + cbResponse.phone_number + "</p>" +
				   						 "<p><b>Twitter: </b>" + cbResponse.twitter_username + "</p>" +
				   						 "<p><b>Category: </b>" + cbResponse.category_code + "</p>" + 
				   						 "<p><b>Employees: </b>" + cbResponse.number_of_employees + "</p>" +
				   						 "<p><b>Overview: </b>" + cbResponse.overview + "</p>");

				   //Check if Company image details exist on Crunchbase
				   if(cbResponse.image != null){
				   		if(cbResponse.image.available_sizes.length > 0){
							j$("#response").append("<p><b>Logo: </b>" + "<img src=http://www.crunchbase.com/" + 
				   								cbResponse.image.available_sizes[0][1] + "/>" + "</p>");				   		
				   		}
				   }
				   
				   //Check if Product details exist on Crunchbase
				   if(cbResponse.products != null){
				   		var cbProducts;
				   		for(cnt = 0; cnt < cbResponse.products.length; cnt++){
				   			cbProducts = cnt == 0 ? cbResponse.products[cnt].name + ", " : cbProducts + cbResponse.products[cnt].name + ", ";  
				   		}
				   		j$("#response").append("<p><b>Products: </b>" + removeTrailingComma(cbProducts) + "</p>");
				   }
				   
				   //Check if People details exist on Crunchbase
				   if(cbResponse.relationships != null){
				   		var cbPeople; var personName;
				   		for(cnt = 0; cnt < cbResponse.relationships.length; cnt++){
				   			personName = cbResponse.relationships[cnt].person.first_name + " " + 
				   						 cbResponse.relationships[cnt].person.last_name;
				   			
				   			if(cbResponse.relationships[cnt].title.length > 0){ 
				   				cbPeople = (cnt == 0) ? personName + " (" + cbResponse.relationships[cnt].title + "), " : 
				   									  cbPeople + personName + " (" + cbResponse.relationships[cnt].title + "), ";	
				   			}
				   			else
				   			{ cbPeople = (cnt == 0) ? personName + ", " : cbPeople + personName + ", "; } 
				   		}
				   		j$("#response").append("<p><b>People: </b>" + removeTrailingComma(cbPeople) + "</p>");
				   }
				   
				   //Check if Milestone details exist on Crunchbase
				   if(cbResponse.milestones != null && cbResponse.investments.length > 0){
						j$("#response").append("<p><b> Milestones: </b></p>");
				   		for(cnt = 0; cnt < cbResponse.milestones.length; cnt++){
							j$("#response").append("<p><i><b>" + cbResponse.milestones[cnt].description + "</i></b></p>" +
												   "<p>" + "<i> Date: </i>" + cbResponse.milestones[cnt].stoned_month + "/" + 
												   		   cbResponse.milestones[cnt].stoned_day + "/" + 
												   		   cbResponse.milestones[cnt].stoned_year + "</p>");		   		
				   			
				   			if(cbResponse.milestones[cnt].source_url != null){
				   				j$("#response").append("<p><i> Source: " + cbResponse.milestones[cnt].source_url + "</i></p>");
				   			}
				   			else
				   			{j$("#response").append("<p><i> Source: NA </i></p>");}
				   		}
				   }
				   
				   //Check if Investment details exist on Crunchbase
				   if(cbResponse.investments != null && cbResponse.investments.length > 0){
						j$("#response").append("<p><b> Fundings: </b></p>");
				   		for(cnt = 0; cnt < cbResponse.investments.length; cnt++){
							j$("#response").append("<p><i><b> Funded " + 
													cbResponse.investments[cnt].funding_round.raised_amount + " " +  
													cbResponse.investments[cnt].funding_round.raised_currency_code + " in " + 
													cbResponse.investments[cnt].funding_round.company.name  + " on " +
													cbResponse.investments[cnt].funding_round.funded_month  + "/" +
													cbResponse.investments[cnt].funding_round.funded_day  + "/" +
													cbResponse.investments[cnt].funding_round.funded_year + "</b></i></p>");
															   		
				   			if(cbResponse.investments[cnt].funding_round.source_url != null){
				   				j$("#response").append("<p><i> Source: " + cbResponse.investments[cnt].funding_round.source_url + "</i></p>");
				   			}
				   			else
				   			{j$("#response").append("<p><i> Source: NA </i></p>");}
				   		}
				   }
				   
				});//getJSON
		}
		
		//Removes the trailing comma and space from the end of the string 
		function removeTrailingComma(csvString){
			return csvString.substr(0, csvString.length - 2);
		}
	</script>
	
	<apex:form >
		<apex:actionFunction name="initParams" action="{!init}" oncomplete="getCrunchbaseJSONResponse('{!currPermalink}');return false;"/>
	</apex:form>
	<apex:outputField value="{!Account.Crunchbase_Permalink__c}" rendered="false"/>
	<div id="response"></div>
	
</apex:page>